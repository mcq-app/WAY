<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Deutsch mit Ibrahim</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script type="Module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signInWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

/* ================= Firebase ================= */

const firebaseConfig = {
  apiKey: "AIzaSyAXRcM3jlAEyMMCqqXcOALCzbXVFoiopzA",
  authDomain: "deutsch-mit-ibrahim-35ee6.firebaseapp.com",
  projectId: "deutsch-mit-ibrahim-35ee6",
  storageBucket: "deutsch-mit-ibrahim-35ee6.firebasestorage.app",
  messagingSenderId: "906444610272",
  appId: "1:906444610272:web:963fbc60739b0c80034e85",
  measurementId: "G-W8KZPKXV6T"

};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= Load Subjects ================= */

async function loadSubjects() {
  const subjectSelect = document.getElementById("subject");
  subjectSelect.innerHTML = '<option value="">Modul auswählen</option>';

  const snapshot = await getDocs(collection(db, "subjects"));

  snapshot.forEach(doc => {
    const option = document.createElement("option");
    option.value = doc.id;
    option.textContent = doc.id;
    subjectSelect.appendChild(option);
  });
}

/* ================= Load Teils ================= */

async function loadTeils(subjectId) {
  const teilSelect = document.getElementById("teil");
  teilSelect.innerHTML = '<option value="">Teil auswählen</option>';
  teilSelect.disabled = true;

  const snapshot = await getDocs(
    collection(db, "subjects", subjectId, "teils")
  );

  snapshot.forEach(doc => {
    const option = document.createElement("option");
    option.value = doc.id;
    option.textContent = doc.id;
    teilSelect.appendChild(option);
  });

  if (!snapshot.empty) teilSelect.disabled = false;
}

/* ================= Load Titles ================= */

async function loadTitles(subjectId, teilId) {
  const titleSelect = document.getElementById("title");
  titleSelect.innerHTML = '<option value="">Text auswählen</option>';
  titleSelect.disabled = true;

  const snapshot = await getDocs(
    collection(db, "subjects", subjectId, "teils", teilId, "titles")
  );

  snapshot.forEach(doc => {
    const option = document.createElement("option");
    option.value = doc.id;
    option.textContent = doc.id;
    titleSelect.appendChild(option);
  });

  if (!snapshot.empty) titleSelect.disabled = false;
}

/* ================= Authentication ================= */

onAuthStateChanged(auth, user => {
  authLoading.classList.add("hidden");

  if (user) {
    loginView.classList.add("hidden");
    selectView.classList.remove("hidden");
    loadSubjects();
  } else {
    loginView.classList.remove("hidden");
    selectView.classList.add("hidden");
  }
});

loginBtn.onclick = async () => {
  try {
    await signInWithEmailAndPassword(
      auth,
      email.value,
      password.value
    );
  } catch (e) {
    alert(e.message);
  }
};

/* ================= Events ================= */

subject.addEventListener("change", e => {
  if (e.target.value) loadTeils(e.target.value);
});

teil.addEventListener("change", e => {
  if (e.target.value) loadTitles(subject.value, e.target.value);
});

startBtn.onclick = () => {
  if (!subject.value || !teil.value ) {
    alert("Bitte wählen Sie Modul, Teil aus");
    return;
  }

  const params = new URLSearchParams({
    subjectId: subject.value,
    teil: teil.value
  });
  if (title.value) {
  params.set("title", title.value);
}

  window.location.href = `exam.html?${params.toString()}`;
};
</script>
<!-- ===== Access Code Overlay ===== -->
<div id="accessOverlay" style="
position:fixed; inset:0; background:rgba(0,0,0,.6);
display:flex; align-items:center; justify-content:center;
z-index:99999;">

  <div style="
  background:white; padding:20px; border-radius:12px;
  width:90%; max-width:360px; text-align:center;">

    <h3 style="margin-bottom:12px; font-weight:bold;">
      رمز التحقق
    </h3>

    <input id="accessCodeInput" type="password"
    placeholder="ادخل رمز التحقق"
    style="
    width:100%; padding:10px; border:2px solid #ccc;
    border-radius:8px; margin-bottom:12px;
    outline:none;">

    <button id="verifyAccessBtn"
    style="
    width:100%; padding:10px;
    background:#2563eb; color:white;
    border:none; border-radius:8px;
    font-weight:bold; cursor:pointer;">
      تحقق
    </button>

    <div id="accessError"
    style="color:#b00020; margin-top:10px; font-size:14px;"></div>
  </div>
</div>
<script>
const ACCESS_KEY = "WAY_ACCESS_OK";
const EXCEL_URL = "https://mcq-app.github.io/WAY/pass.xlsx";

if (localStorage.getItem(ACCESS_KEY) === "true") {
  document.getElementById("accessOverlay").style.display = "none";
}

document.getElementById("verifyAccessBtn").onclick = async () => {
  const input = document.getElementById("accessCodeInput").value.trim();
  const error = document.getElementById("accessError");
  error.textContent = "";

  if (!input) {
    error.textContent = "الرجاء إدخال الرمز";
    return;
  }

  try {
    const res = await fetch(EXCEL_URL);
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const validCodes = rows.flat().map(v => String(v).trim());

    if (validCodes.includes(input)) {
      localStorage.setItem(ACCESS_KEY, "true");
      document.getElementById("accessOverlay").style.display = "none";
    } else {
      error.textContent = "رمز غير صحيح";
    }

  } catch (e) {
    error.textContent = "فشل تحميل ملف التحقق";
  }
};
</script>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center px-4">

<div class="w-full max-w-md">

<!-- ===== HEADER ===== -->
<div class="text-center mb-8">
  <h1 class="text-3xl font-extrabold text-blue-700">
    Deutsch mit Ibrahim
  </h1>
  <p class="text-gray-600 mt-2">
    B1 Prüfung
  </p>
</div>

<!-- ===== LOADING ===== -->
<div id="authLoading"
class="bg-white p-6 rounded-xl shadow text-center">
  <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"></div>
  <p class="mt-4 text-gray-600">Authentifizierung...</p>
</div>

<!-- ===== LOGIN ===== -->
<div id="loginView"
class="bg-white p-6 rounded-xl shadow hidden">

  <h2 class="text-lg font-semibold text-gray-800 mb-4 text-center">
    Login
  </h2>

  <input id="email" type="email" placeholder="E-Mail"
  class="w-full border p-2 mb-3 rounded focus:outline-none focus:ring focus:ring-blue-200">

  <input id="password" type="password" placeholder="code"
  class="w-full border p-2 mb-4 rounded focus:outline-none focus:ring focus:ring-blue-200">

  <button id="loginBtn"
    <hr class="my-4">
<input id="accessCodeInput"
type="password"
placeholder="رمز التحقق"
class="w-full border p-2 mb-2 rounded">

<button id="verifyAccessBtn"
class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded transition">
تحقق
</button>

<p id="accessError"
class="text-sm text-red-600 mt-2 text-center"></p>
    <script>
// const ACCESS_KEY = "WAY_ACCESS_OK";
// const EXCEL_URL = "https://mcq-app.github.io/WAY/pass.xlsx";

function hideAccessUI(){
  document.getElementById("accessCodeInput")?.classList.add("hidden");
  document.getElementById("verifyAccessBtn")?.classList.add("hidden");
}

if (localStorage.getItem(ACCESS_KEY) === "true") {
  hideAccessUI();
}

document.getElementById("verifyAccessBtn").onclick = async () => {
  const input = document.getElementById("accessCodeInput").value.trim();
  const error = document.getElementById("accessError");
  error.textContent = "";

  if (!input) {
    error.textContent = "أدخل رمز التحقق";
    return;
  }

  try {
    const res = await fetch(EXCEL_URL);
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const validCodes = rows.flat().map(v => String(v).trim());

    if (validCodes.includes(input)) {
      localStorage.setItem(ACCESS_KEY, "true");
      hideAccessUI();
    } else {
      error.textContent = "رمز غير صحيح";
    }
  } catch {
    error.textContent = "خطأ في التحقق";
  }
};
</script> 
  </button>

  <a href="https://t.me/DeutschmitIbrahimbot" target="_blank"
  class="block w-full text-center bg-sky-500 hover:bg-sky-600 text-white p-2 rounded transition">
    طلب كود
  </a>
</div>

<!-- ===== SELECT EXAM ===== -->
<div id="selectView"
class="bg-white p-6 rounded-xl shadow hidden">

  <h2 class="text-lg font-semibold text-gray-800 mb-4 text-center">
    auswählen
  </h2>

  <select id="subject" class="w-full border p-2 mb-3 rounded">
    <option value="">Modul</option>
  </select>

  <select id="teil" class="w-full border p-2 mb-3 rounded" disabled>
    <option value="">Teil</option>
  </select>

  <select id="title" class="w-full border p-2 mb-4 rounded" disabled>
    <option value="">Text</option>
  </select>

  <button id="startBtn" class="w-full bg-green-600 hover:bg-green-700 text-white p-2 rounded transition">
    starten
  </button>
</div>

</div>
  <button id="excelLogoutBtn"
style="
position:fixed;
bottom:20px;
right:20px;
z-index:99999;
background:#dc2626;
color:white;
border:none;
border-radius:50%;
width:52px;
height:52px;
font-size:20px;
cursor:pointer;
box-shadow:0 4px 10px rgba(0,0,0,.3);
">
⎋
</button>

<script>
document.getElementById("excelLogoutBtn").onclick = () => {
  localStorage.removeItem("WAY_ACCESS_OK");
  location.reload();
};
</script>
<!-- نافذة تأكيد تسجيل الخروج -->
<div id="logoutConfirmModal" style="
position:fixed; inset:0; background:rgba(0,0,0,.5);
display:none; align-items:center; justify-content:center;
z-index:100000;">
  <div style="
    background:white; padding:20px; border-radius:12px; width:90%; max-width:360px; text-align:center;">
    <p style="margin-bottom:16px; font-weight:bold; font-size:16px;">
      هل تريد تسجيل الخروج، سيتم حذف الكود الخاص بك
    </p>
    <div style="display:flex; gap:10px; justify-content:center;">
      <button id="logoutCancelBtn" style="
        flex:1; padding:10px; border-radius:8px; border:2px solid #2563eb;
        background:white; color:#2563eb; font-weight:bold; cursor:pointer;">
        عودة
      </button>
      <button id="logoutConfirmBtn" style="
        flex:1; padding:10px; border-radius:8px; border:none;
        background:#dc2626; color:white; font-weight:bold; cursor:pointer;">
        تسجيل الخروج
      </button>
    </div>
  </div>
</div>

<script>
const logoutBtn = document.getElementById("excelLogoutBtn");
const logoutModal = document.getElementById("logoutConfirmModal");
const logoutCancel = document.getElementById("logoutCancelBtn");
const logoutConfirm = document.getElementById("logoutConfirmBtn");

logoutBtn.onclick = () => {
  logoutModal.style.display = "flex";
};

logoutCancel.onclick = () => {
  logoutModal.style.display = "none";
};

logoutConfirm.onclick = () => {
  localStorage.removeItem("WAY_ACCESS_OK");
  location.reload();
};
</script>

</body>
</html>
